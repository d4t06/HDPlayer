import{formatTime,getLocalStorageItem,setLocalStorage}from"./utils/appHelper.js";import{cdImg,playBtn,timeSlider,timeSliderHolder,currentTimeEle,durationEle,volumeSlider,volumeSliderHolder,audio,control}from"./constant.js";const $=document.querySelector.bind(document);let intervalId=null,setLocalStorageTimerId=0;export const handleOnPause=function(e){playBtn.classList.remove("playing","waiting"),e.isPlaying=!1,clearInterval(setLocalStorageTimerId)};export const handleTimeUpdate=function(){const e=audio.currentTime,t=(e/audio.duration*100).toFixed(1);timeSlider.style.background=`linear-gradient(to right, #999 ${t}%, #e1e1e1 ${t}%, #e1e1e1 100%)`,timeSliderHolder.style.left=t+"%",currentTimeEle.innerText=formatTime(e)||"00:00"};export const updateVolume=e=>{audio.volume=e,volumeSliderHolder.style.left=100*e+"%",volumeSlider.style.background=`linear-gradient(to right, #999 ${100*e}%, #e1e1e1 ${100*e}%, #e1e1e1 100%)`};export default function handleAudioEvent(){const e=this,t=()=>{intervalId&&clearInterval(intervalId);let e,t,i=$(".title-wrapper h2"),a=$(".title-wrapper");if(!i||!a)return;const n=()=>{i.style.transition=`transform linear ${e}s`,i.style.transform=`translateX(-${t}px)`,setTimeout((()=>{(()=>{let e=$(".title-wrapper h2");console.log("unscroll text"),e.style.transition="unset",e.style.transform="translateX(0px)"})()}),1e3*e)};i.offsetWidth-a.offsetWidth>0&&(t=i.offsetWidth+20,e=+(t/35).toFixed(1),i.innerHTML=i.innerText+"&nbsp; &nbsp; &nbsp;"+i.innerText,n(),intervalId=setInterval((()=>{n()}),1e3*e+3e3+1e3))};audio.onplaying=function(){playBtn.classList.remove("waiting"),playBtn.classList.add("playing"),e.isPlaying=!0,e.isWaiting=!1,setLocalStorageTimerId=setInterval((()=>{setLocalStorage("current-time",Math.ceil(audio.currentTime)),console.log("set time")}),3e3)},audio.onpause=()=>{console.log("pause"),handleOnPause(e)},audio.onerror=()=>{if(!e.songs.length)return handleOnPause();e.nextSong()},audio.onended=function(){return e.isRepeat?audio.play():e.isRandom?e.randomSong():void e.nextSong()},audio.onseeked=()=>{clearInterval(setLocalStorageTimerId)},audio.addEventListener("timeupdate",handleTimeUpdate),audio.addEventListener("loadstart",(()=>{this.isWaiting=!0,playBtn.classList.add("waiting"),timeSlider.classList.add("disable"),control.classList.remove("disable")})),audio.addEventListener("loadedmetadata",(i=>{if(durationEle.innerText=formatTime(i.target.duration),this.isWaiting=!1,timeSlider.classList.remove("disable"),e.isFirstLoadSong){const t=getLocalStorageItem("current-time",0);return audio.currentTime=t,void(e.isFirstLoadSong=!1)}e.endOfList?e.endOfList=!1:e.isPlaying||(t(),audio.play())}))}