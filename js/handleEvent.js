import{formatTime,setLocalStorage}from"./utils/appHelper.js";import{dashboard,cd,cdImg,playBtn,prevBtn,nextBtn,randomBtn,rePeatBtn,musicVolume,gotopBtn,timeSlider,timeSliderHolder,currentTimeEle,durationEle,volumeSlider,volumeSliderHolder}from"./constant.js";const $=document.querySelector.bind(document),$$=document.querySelectorAll.bind(document);let intervalId=null;const onPauseHandle=function(t){playBtn.classList.remove("playing"),t.isPlaying=!1,cdImg.style.animationPlayState="paused"},updateVolume=t=>{$(".audio").volume=t,volumeSliderHolder.style.left=100*t+"%",volumeSlider.style.background=`linear-gradient(to right, #999 ${100*t}%, #e1e1e1 ${100*t}%, #e1e1e1 100%)`},handleEvents=function(){const t=this,e=$(".audio"),n=$$(".song-item"),o=cd.offsetWidth,i=window.innerWidth>=724,l=function(){e.play(),t.isPlaying=!0,playBtn.classList.add("playing")},a=function(t){setTimeout((()=>{t.scrollIntoView({behavior:"smooth",block:"center"})}),200)},r=t=>{const e=$(".song-item.active");if(!e)return;if(void 0!==t)return a(n[t]);const o=e.getBoundingClientRect(),l=dashboard.offsetHeight,r=i?o.top>0:o.top>l,s=o.top<window.innerHeight;r&&s&&a(e)};cdImg.onclick=()=>{r(t.currentIndex)};const s=()=>{intervalId&&clearInterval(intervalId);let t,e,n=$(".title-wrapper h2"),o=$(".title-wrapper");if(!n||!o)return;const i=()=>{n.style.transition=`transform linear ${t}s`,n.style.transform=`translateX(-${e}px)`,setTimeout((()=>{(()=>{let t=$(".title-wrapper h2");console.log("unscroll text"),t.style.transition="unset",t.style.transform="translateX(0px)"})()}),1e3*t)};n.offsetWidth-o.offsetWidth>0&&(e=n.offsetWidth+20,t=+(e/35).toFixed(1),n.innerHTML=n.innerText+"&nbsp; &nbsp; &nbsp;"+n.innerText,i(),intervalId=setInterval((()=>{i()}),1e3*t+3e3+1e3))};n.forEach(((e,n)=>{e.onclick=o=>{o.target.parentElement.classList.contains("song-detail")||t.currentSong&&e.id===t.currentSong.id||(t.currentIndex=n,t.loadCurrentSong())}})),window.onscroll=function(){if(i)return;const t=window.scrollY||document.documentElement.scrollTop,e=o-t/2,n=e/o;if(e<0)return cd.style.width="0px",cd.style.opacity=0,void gotopBtn.classList.add("show");cd.style.width=e+"px",cd.style.opacity=n,gotopBtn.classList.remove("show")};e.onplaying=e=>(playBtn.classList.add("playing"),playBtn.classList.remove("waiting"),t.isPlaying=!0,t.isWaiting=!1,void(cdImg.style.animationPlayState="running")),e.onpause=()=>{onPauseHandle(t)},e.ontimeupdate=function(){const t=e.currentTime,n=(t/e.duration*100).toFixed(1);timeSlider.style.background=`linear-gradient(to right, #999 ${n}%, #e1e1e1 ${n}%, #e1e1e1 100%)`,timeSliderHolder.style.left=n+"%",currentTimeEle.innerText=formatTime(t)||"00:00"},e.onended=function(){return t.isRepeat?l():t.isRandom?t.randomSong():void t.nextSong()},e.addEventListener("loadedmetadata",(e=>{durationEle.innerText=formatTime(e.target.duration),t.isFirstLoadSong?t.isFirstLoadSong=!1:t.endOfList?t.endOfList=!1:t.isPlaying||(r(),s(),l())})),musicVolume.onclick=function(t){let e=musicVolume.offsetWidth,n=(t.clientX-25)/e;updateVolume(+n.toFixed(2)),setLocalStorage("volume",n.toFixed(2))},musicVolume.onwheel=function(t){t.preventDefault();const n=.05;let o=e.volume;t.deltaY>0?o-n>0?o-=n:o=0:o+n<1?o+=n:o=1,updateVolume(+o.toFixed(2)),setLocalStorage("volume",o.toFixed(2))},timeSlider.onclick=n=>{let o=timeSlider.offsetWidth,i=Math.floor((n.clientX-25)/o*100),a=e.duration*i/100;e.currentTime=+a.toFixed(2),t.isPlaying||this.isWaiting||l()},playBtn.onclick=function(){t.isPlaying?e.pause():e.play()},nextBtn.onclick=function(){t.nextSong(),t.endOfList=!1},prevBtn.onclick=function(){t.prevSong()},randomBtn.onclick=function(){const e=!t.isRandom;t.isRandom=e,setLocalStorage("isRandom",e),randomBtn.classList.toggle("active",e)},rePeatBtn.onclick=function(){const e=!t.isRepeat;t.isRepeat=e,setLocalStorage("isRepeat",e),rePeatBtn.classList.toggle("active",e)},gotopBtn.onclick=()=>r(0)};export{onPauseHandle,updateVolume};export default handleEvents;